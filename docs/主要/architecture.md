# Architecture Components



本文件详细介绍了 QFramework 中的四大主要架构层： Controllers, Systems, Models, and Utilities，以及它们的责任、交互规则和由 Command 模式协调的它们之间状态变化的模式。有关具体命令和查询实现的更多信息，请参见[命令与查询]。有关事件驱动通信的详细信息，请参见[事件系统]。

## 简介

QFramework 实现了一种分层的类似 MVC 的架构，并且各层之间有严格的通信规则。该架构由四个主要层组成，并且通过依赖注入和事件系统协调，还使用了命令模式进行状态管理。

### 架构

![架构](images\arch-flow.png)

## Layer Responsibilities 分层职责

### IController - 表现层

`IController` 接口表示表现层，通常由 Unity `MonoBehaviour` 组件实现。控制器处理用户输入并响应来自较低层的状态变化。

Responsibilities:

- 接收并处理用户输入
- 显示 UI 更新和视觉反馈
- 通过发送命令 orchestrates 游戏逻辑
- 监听来自系统的事件和模型的事件

**Allowed Operations:**

- ✅ 获取 System 实例
- ✅ 获取 Model 实例
- ✅ 发送命令
- ✅ 监听事件
- ❌ 直接修改Systems/Models的状态

### ISystem - 系统层

`ISystem`接口表示在多个控制器之间运行的共享业务逻辑。系统处理游戏机制、计时器、商店、成就等。

**职责：**

- 实现共享游戏逻辑
- 管理跨控制器功能
- 处理事件并协调响应
- 为控制器提供业务逻辑 API

** **允许的操作：****

- ✅ 获取其他 System 实例
- ✅ 获取 Model 实例
- ✅ 监听事件
-  ✅ 发送事件
- ❌ 直接访问控制器
- ❌ 直接修改状态（使用命令）

### IModel - 数据层

`IModel`接口代表数据层，负责数据定义并提供 CRUD 操作。模型维护程序状态和业务数据。

**Responsibilities:**

- 定义数据结构和模式
- 提供数据访问方法（CRUD）
- 维护应用程序状态
- 通知监听者状态变化

 **允许的操作：**

- ✅ 获取工具类实例
-  ✅ 发送事件
- ❌ 访问控制器或系统
- ❌ 上层直接修改

### IUtility - 工具层

``IUtility`` 接口代表基础设施服务和基础功能。工具提供低级别的服务，如存储、序列化、网络通信和第三方集成。

 **职责：**

- 提供基础设施服务
- 实现存储和序列化
- 处理网络通信
- 集成第三方库和 SDK
- 提供平台特定的功能

 **允许的操作：**

- ✅ 访问其他工具类
- ❌ 任何上层模块的访问权限
-  ❌ 状态管理
-  ❌ 业务逻辑



## 命令模式集成 

命令是架构中状态更改的主要机制。`ICommand` 接口封装了状态修改操作，并强制执行适当的分层规则。

 **命令规则：**

- 命令必须无状态
- 命令可以获取系统和模型实例
- 命令可以发送事件
- 命令可以触发其他命令
- 只有控制器可以发起命令以改变状态

##  通信模式

该架构通过严格的层间通信规则来维护职责分离并确保数据流的正确性。

### Communication Rules

| 从层        | 到层     | 允许的方法     | 限制             |
| ----------- | -------- | -------------- | ---------------- |
| IController | ISystem  | 查询方法，命令 | 无直接状态更改   |
| IController | IModel   | 查询方法，命令 | 无直接状态更改   |
| ISystem     | IModel   | 所有方法       | 通过事件改变状态 |
| ISystem     | IUtility | 所有方法       | -                |
| IModel      | IUtility | 所有方法       | -                |
| 任何层      | 上层     | 仅事件         | 无直接访问       |

 **关键规则：**

1. 高层可以访问低层 - 通过查询和命令
2. **较低层通过事件向上层通信** - 维护松耦合
3. **状态变化必须使用命令** - 除非是 IController 的特殊情况
4. **命令中无状态** - 命令是纯粹的操作
5. **事件用于通知** - 当 ISystem/IModel 状态变化时

## 架构集成

### 核心框架集成

![架构图](images/arch-core.png)

`Architecture` 类充当中央协调器，负责管理依赖注入的 IOC 容器和跨层通信的事件系统。每一层的组件都会被注册到 IOC 容器中，并根据各自层的规则参与事件系统。

**来源：**基于提供的架构图

## 实现指南 

###  层注册 

- 所有层级组件必须注册到`Architecture<T>`实例
- 依赖关系通过`IOCContainer`解析
- 事件订阅通过`TypeEventSystem`管理

###  状态管理

- 使用命令从控制器修改所有状态
- 模型应在状态发生变化时发出事件
- 系统在模型之间进行协调，并通过事件通知控制器

###  错误处理

- 每一层应处理其自身的领域特定错误
- 跨层错误通信应使用事件
- 命令应原子化，并在需要时处理回滚

这种架构促进了职责清晰分离、易于测试和维护，并为应用程序不同部分之间如何交互提供了明确的规则。